# RAG 챗봇 기능 이주 개발 계획서

> **작성일**: 2025-08-07 11:10  
> **대상**: rag-chatbot → rag-chatbot-2 기능 이주  
> **목적**: Express.js 기반에서 Fastify + TypeScript 기반으로 안전한 마이그레이션  

## 개요

기존 rag-chatbot의 기능들을 새로운 Fastify + TypeScript 환경으로 단계적으로 이주하는 개발 계획입니다. 각 단계별로 테스트와 검증을 거쳐 안정적인 기능 이전을 목표로 합니다.

## 마이그레이션 전략

### 기본 원칙
- **점진적 이주**: 한 번에 하나의 기능만 추가
- **단계별 검증**: 각 단계마다 기능 테스트 수행
- **안정성 우선**: REST API → WebSocket 순으로 점진적 개선
- **타입 안전성**: TypeScript 타입 정의 선행

### 작업 방식
- **구조 우선**: 각 단계 시작 전 관련 타입 정의 및 서비스 클래스 구조 먼저 생성
- **필요한 것만**: 해당 단계에 필요한 폴더/파일만 선택적 생성 (전체 구조 미리 생성 금지)
- **단계별 완성도**: 각 단계의 기본 구조 → 실제 구현 → 테스트 → 다음 단계 진행
- **문서화 병행**: 주요 변경사항은 즉시 문서 업데이트

### 기술 스택 변화
| 구분 | 기존 (rag-chatbot) | 신규 (rag-chatbot-2) |
|------|-------------------|----------------------|
| **프레임워크** | Express.js | Fastify |
| **언어** | JavaScript | TypeScript |
| **실시간 통신** | 없음 | WebSocket (Socket.io) |
| **아키텍처** | 단순 구조 | 레이어드 아키텍처 |

## 상세 개발 단계

### 1단계: 기초 구조 구축 🏗️
**예상 소요시간**: 1-2시간  
**목표**: 노션 연동을 위한 기본 타입 및 구조 정의

#### 작업 내용 (완료)
- [x] **기본 타입 정의**
  - `ApiResponse`, `ServiceStatus`, `HealthStatus` 등 공통 타입
  - `Document`, `DocumentSource`, `DocumentMetadata` 문서 타입
  - `NotionConfig`, `NotionPage`, `NotionQueryResult` 노션 타입

- [x] **노션 서비스 클래스 구조 생성**
  - `NotionService` 클래스 스켈레톤 (초기화, 상태 확인 메서드 포함)
  - `NotionMapper` 데이터 변환 클래스 (노션 → Document 변환)
  - `notion.constants.ts` 노션 관련 상수 정의

- [x] **폴더 구조 생성**
  - 필요한 폴더만 선택적 생성 (`types/`, `services/notion/`)
  - 각 폴더별 index.ts 파일로 export 구조 설정

#### 완료 기준 (달성)
- ✅ 노션 관련 모든 타입 정의 완료, 컴파일 에러 없음
- ✅ NotionService 클래스 기본 구조 생성 완료
- ✅ 타입 안전성 확보 (exactOptionalPropertyTypes 호환)

---

### 2단계: 노션 데이터베이스 연동 📚 ✅ COMPLETED
**예상 소요시간**: 2-3시간  
**목표**: 노션에서 문서 데이터 읽기 기능

#### 작업 내용
- [x] **테스트 환경 설정**
  - `.env.test` 파일 생성 및 환경변수 설정
  - Jest 테스트 프레임워크 구성 및 최적화
  - NotionService 단위 테스트 작성 및 모킹

- [x] **노션 서비스 기본 구조**
  - NotionService 클래스 생성자 및 초기화 메서드
  - 연결 상태 확인 및 헬스체크 연동
  - 기본 에러 핸들링 구조

- [x] **노션 API 연동 구현** ✅
  - `getPages()` 메서드: 데이터베이스 쿼리 기능 구현
  - `getPageContent()` 메서드: 페이지 내용 읽기 구현  
  - `queryDatabase()` 메서드: 필터링된 쿼리 기능

- [x] **데이터 변환 로직** ✅
  - Notion 블록 → 마크다운 변환 기본 구현
  - 문서 메타데이터 추출 (제목, 수정일, URL 등)
  - `NotionPage` 타입으로 정규화

- [x] **에러 핸들링**
  - API 호출 실패 처리 구조
  - 타임아웃 및 재시도 로직 기본 구조
  - 테스트를 통한 에러 시나리오 검증

#### 완료 기준 (모두 달성 ✅)
- [x] 헬스체크에서 노션 연결 상태 확인 가능
- [x] 노션 데이터베이스에서 문서 목록 조회 가능
- [x] 개별 문서 내용을 마크다운으로 변환 가능

#### 구현 완료 사항
- **NotionService 메서드 구현**: `getPages(filter?)`, `getPage(pageId)` 실제 로직 완료
- **메서드 통합 및 개선**: 
  - `getPages()` + `queryDatabase()` → `getPages(filter?)` 통합
  - `getPageContent()` → `getPage()` 네이밍 개선
  - 매직 넘버를 상수로 대체 (`MAX_NOTION_PAGE_SIZE`)
- **관심사 분리**: 
  - 데이터 변환 로직을 `NotionMapper`로 완전 이동
  - 블록 타입 상수 활용 (`NOTION_BLOCK_TYPES`)
- **타입 중복 제거**: `NotionPage.title`과 `properties.title` 중복 해결
- **기본 마크다운 변환**: 제목, 문단, 리스트 등 주요 블록 타입 지원
- **에러 처리**: API 호출 실패, 타입 안전성, 로깅 완료
- **포괄적 테스트 구현**: ✅
  - **NotionService 테스트**: 43개 테스트 케이스 (정상/에러 케이스 포함)
  - **NotionMapper 테스트**: 모든 유틸리티 메서드 검증
  - **테스트 커버리지**: NotionService/NotionMapper 99%+ 달성
  - **실행 속도**: 0.7초 내 완료 (개발 흐름 방해 없음)

---

### 3단계: OpenAI API 연동 🤖
**예상 소요시간**: 1-2시간  
**목표**: LLM 및 임베딩 API 기본 연동

#### 작업 내용
- [ ] **OpenAI 클라이언트 설정**
  - API 키 검증 및 연결 테스트
  - 모델별 설정 관리 (GPT-3.5, text-embedding-3-small)

- [ ] **임베딩 생성 기능**
  - 텍스트 → 벡터 임베딩 변환
  - 배치 처리 최적화
  - 토큰 제한 처리

- [ ] **LLM 호출 기본 구조**
  - 프롬프트 템플릿 시스템
  - 응답 스트리밍 준비 (나중에 소켓 연동용)

#### 완료 기준
- OpenAI API 정상 호출 가능
- 임베딩 생성 테스트 성공
- 헬스체크에서 OpenAI 상태 확인 가능

---

### 4단계: 벡터 DB (Pinecone) 연동 🔍
**예상 소요시간**: 2-3시간  
**목표**: 벡터 저장 및 검색 기능 구현

#### 작업 내용
- [ ] **Pinecone 연결 설정**
  - 인덱스 생성 및 연결
  - 벡터 차원 설정 (1536차원, text-embedding-3-small)

- [ ] **벡터 저장 기능**
  - 문서별 벡터 업서트
  - 메타데이터 저장 (문서 ID, 제목, 소스 등)
  - 배치 업로드 최적화

- [ ] **벡터 검색 기능**
  - 유사도 검색 (similarity search)
  - 검색 결과 필터링 및 정렬
  - 임계값 기반 관련성 판단

#### 완료 기준
- Pinecone에 벡터 저장 가능
- 쿼리 벡터로 유사 문서 검색 가능
- 헬스체크에서 Pinecone 상태 확인 가능

---

### 5단계: 임베딩 생성 & 저장 파이프라인 🔄
**예상 소요시간**: 2-3시간  
**목표**: 노션 문서를 벡터로 변환하여 저장하는 전체 파이프라인

#### 작업 내용
- [ ] **문서 처리 파이프라인**
  - 노션 문서 → 청크 분할 → 임베딩 생성 → Pinecone 저장
  - 중복 처리 방지 (문서 해시 기반)
  - 진행상황 로깅

- [ ] **증분 업데이트**
  - 변경된 문서만 다시 처리
  - 삭제된 문서 벡터 제거
  - 배치 작업 스케줄링

- [ ] **관리 API 추가**
  - `/api/documents/refresh` - 전체 문서 재처리
  - `/api/documents/stats` - 처리 통계 확인

#### 완료 기준
- 노션 → Pinecone 전체 파이프라인 동작
- 문서 변경사항 자동 감지 및 업데이트
- 관리 API를 통한 수동 제어 가능

---

### 6단계: 기본 RAG 로직 구현 💬
**예상 소요시간**: 3-4시간  
**목표**: 질문 → 벡터 검색 → LLM 응답 전체 플로우

#### 작업 내용
- [ ] **RAG 파이프라인 구현**
  - 사용자 질문 → 임베딩 변환
  - 벡터 검색으로 관련 문서 추출
  - 컨텍스트 + 질문 → LLM 프롬프트 생성
  - LLM 응답 생성 및 후처리

- [ ] **응답 품질 개선**
  - 프롬프트 엔지니어링
  - 컨텍스트 길이 최적화
  - 신뢰도 점수 계산

- [ ] **오류 상황 처리**
  - 관련 문서 없음 → 적절한 안내 메시지
  - API 호출 실패 → 재시도 로직
  - 응답 타임아웃 → 사용자 알림

#### 완료 기준
- 질문에 대한 적절한 답변 생성 가능
- 출처 정보 포함된 응답 제공
- 다양한 에러 상황 적절히 처리

---

### 7단계: REST 채팅 API 생성 🌐
**예상 소요시간**: 1-2시간  
**목표**: 기본적인 채팅 API 엔드포인트 구현

#### 작업 내용
- [ ] **채팅 API 구현**
  - `POST /api/chat` 엔드포인트
  - 요청/응답 검증 (Zod 스키마)
  - 에러 처리 및 상태 코드

- [ ] **API 문서화**
  - 요청/응답 스키마 정의
  - 예시 요청/응답 작성
  - 에러 코드 정의

#### 완료 기준
- REST API로 채팅 기능 완전 동작
- API 문서 작성 완료
- Postman/curl로 테스트 가능

---

### 8단계: FE 프로젝트 + 기본 UI 🎨
**예상 소요시간**: 4-6시간  
**목표**: 기본적인 웹 UI로 채팅 기능 테스트

#### 작업 내용
- [ ] **FE 프로젝트 생성**
  - Next.js 또는 React + Vite 선택
  - TypeScript 설정
  - 기본 UI 라이브러리 (Tailwind CSS)

- [ ] **채팅 UI 구현**
  - 메시지 목록 표시
  - 질문 입력 폼
  - 로딩 상태 표시
  - 출처 정보 표시

- [ ] **REST API 연동**
  - HTTP 클라이언트 설정
  - 에러 처리
  - 응답 상태 관리

#### 완료 기준
- 웹 브라우저에서 채팅 기능 사용 가능
- 출처 정보 클릭으로 원본 문서 접근 가능
- 기본적인 UX/UI 완성

---

### 9단계: 소켓 연동으로 업그레이드 ⚡
**예상 소요시간**: 3-4시간  
**목표**: 실시간 스트리밍 응답 구현

#### 작업 내용
- [ ] **Socket.io 서버 설정**
  - Fastify Socket.io 플러그인 추가
  - 네임스페이스 및 룸 관리
  - 연결 상태 관리

- [ ] **스트리밍 응답 구현**
  - OpenAI 스트리밍 API 활용
  - 실시간 토큰 전송
  - 진행상황 표시

- [ ] **FE 소켓 클라이언트**
  - Socket.io 클라이언트 연동
  - 실시간 메시지 수신
  - 연결 상태 표시

#### 완료 기준
- 실시간으로 응답이 스트리밍됨
- 연결 끊김/재연결 처리
- 여러 사용자 동시 접속 지원

---

## 마일스톤 및 검증 포인트

### 마일스톤 1: 데이터 연동 완료 (1-4단계)
- [x] 노션에서 문서 읽기 가능 ✅
- [ ] OpenAI로 임베딩/LLM 호출 가능 🔄
- [ ] Pinecone에 벡터 저장/검색 가능
- [x] 헬스체크에서 모든 서비스 상태 확인 ✅

### 마일스톤 2: RAG 시스템 완성 (5-6단계)
- [ ] 노션 → Pinecone 파이프라인 동작
- [ ] 질문 → 답변 전체 플로우 완성
- [ ] 적절한 품질의 응답 생성

### 마일스톤 3: 사용자 인터페이스 완성 (7-9단계)
- [ ] REST API 완전 동작
- [ ] 웹 UI에서 채팅 사용 가능
- [ ] 실시간 스트리밍 응답 구현

## 위험 요소 및 대응 방안

### 기술적 위험
- **Pinecone API 제한**: 배치 크기 조정 및 재시도 로직
- **OpenAI 토큰 제한**: 컨텍스트 길이 최적화
- **노션 API Rate Limit**: 요청 간격 조정

### 개발 위험
- **타입 정의 불일치**: 각 단계마다 타입 검증 강화
- **성능 이슈**: 각 단계별 성능 측정 및 최적화
- **데이터 일관성**: 트랜잭션 및 롤백 메커니즘

## 성공 기준

### 기능적 요구사항
- [ ] 노션 문서 기반 질의응답 가능
- [ ] 실시간 스트리밍 응답 제공
- [ ] 출처 정보 포함된 답변
- [ ] 관련 문서 없을 때 적절한 안내

### 비기능적 요구사항
- [ ] 응답 시간 5초 이내
- [ ] 동시 사용자 10명 이상 지원
- [ ] 99% 이상 가용성
- [ ] 타입 안전성 보장

---

**다음 단계**: [1단계: 기초 구조 구축] 시작  
**최종 수정일**: 2025-08-07 11:10  
**책임자**: Development Team